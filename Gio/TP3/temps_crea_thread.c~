/**********************************************************************/
/*                                                                    */
/*                  TP3 - TEMPS_CREA_THREAD.C - MION GIOVANNI         */
/*                                                                    */
/**********************************************************************/

#include <time.h>
#include <math.h>
#include <stdlib.h>
#include <stdio.h>
#include <pthread.h>

double array_moy(long* array,int length){
  //decalration des variables
  double cpt;
  int ind;
  
  //Parcour du tableau et calcule de la somme des elements
  cpt=0;
  for(ind=0;ind<length;ind++)
    cpt+=array[ind];
  
  //Retourne la moyenne en divisant la somme par le nombre d'elements
  return cpt/length;
}

void* thread_code(void* args){
  pthread_exit(2);
}

int main(int argc,char** argv){

  //declaration des variables
  pthread_t threads[50];
  struct timespec t_start,t_stop;
  long mem_creations[50];
  double moy;
  int i,j;
  
  //mesure du temps de creation d'un processus
  
  //on fait cette mesure sur 50 cretaions de 50 processus et on calcule la moyenne
  
  for(i=0;i<50;i++){
    
    //prise du temps avant creation.
    clock_gettime(CLOCK_PROCESS_CPUTIME_ID, &t_start);
    for(j=0;j<50;j++){
      //creation du fils
      pthread_create(&threads[i],NULL,thread_code,NULL);
    }
      //dans le pere on attend la fin du fils et l'on recupere le temps
    for(j=0;j<50;j++)
      pthread_join(threads[j],NULL);
    clock_gettime(CLOCK_PROCESS_CPUTIME_ID, &t_stop);
    //on calcule le temps reel passer entre les deux temps et on la stock dans mem_creations
    mem_creations[i]= ( ((t_stop.tv_sec*pow(10,9)+t_stop.tv_nsec) - (t_start.tv_sec*pow(10,9)+t_start.tv_nsec))/50 );
  }
  
  //calule de la moyenne et affichage de celle-ci
  moy = array_moy(mem_creations,50);
  printf("la moyenne de temps pour la creation/destruction de threads est:\n%f nanosecondes\n%f secondes\n",moy,moy/pow(10,9));


  return 1;

}
